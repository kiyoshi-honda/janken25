# 2025-10-28: 対戦履歴表示に関する調査報告

概要
- 要求: じゃんけんの対戦時に過去5戦分を確認できる機能を実装する。対戦履歴を表示する専用ページを作成し、対戦ページから移動できるようにする。
- 本レポートでは実装方法の候補、推奨アプローチ、必要な変更箇所と検証手順をまとめる。

要件（確認済み）
1. 各ユーザごとに過去5戦分を保持・表示すること
2. 対戦ページ（`/janken`）から履歴ページ（例:`/janken/history`）へ遷移可能にすること
3. 履歴は新しい順（直近5件）で表示すること

実装アプローチ候補

A) セッション単位で保持（HttpSessionにList<JankenResult>を保存）
- 実装概要: コントローラで対戦処理後にHttpSessionから履歴リストを取得・更新し、サイズを5に制限する。
- 長所: 最も実装がシンプル。既存のユーザ認証と組み合わせるとユーザ単位で分離される。
- 短所: サーバ再起動やセッションタイムアウトで消える。複数端末での履歴共有不可。
- 変更箇所: `JankenController` にセッション操作を追加、`templates/janken.html` に履歴ページへのリンク、`templates/history.html` を新規作成。
- 工数: 小（数時間）

B) アプリケーションメモリ（@Componentで保持、Map<username, Deque<JankenResult>>）
- 実装概要: シングルトンの履歴サービスを作成し、ユーザ名をキーに deque を保持して直近5件を管理する。
- 長所: セッション外でもユーザ間で履歴を管理可能（同一ユーザの複数セッションに対応）。永続化はしないが管理が一元化される。
- 短所: サーバ再起動で消失。スケールアウト（複数インスタンス運用）時には共有されない。
- 変更箇所: 新規 `JankenHistoryService`（例: `janken/src/main/java/oit/is/z9999/kaizi/janken/service/JankenHistoryService.java`）、`JankenController` から履歴サービスを呼び出す、テンプレート追加。
- 工数: 小〜中（1日未満）

C) 永続化（H2 DB + MyBatis）
- 実装概要: 履歴テーブル（id, username, user_hand, cpu_hand, result, played_at）を作成し、MyBatis MapperでCRUD。画面はDBから直近5件を取得して表示。
- 長所: 永続化されるため信頼性が高い。スケールアウト時もDB共有で対応可能。
- 短所: テーブル定義・マイグレーション・Mapper実装・SQLの追加が必要で工数が増える。
- 変更箇所: DBスキーマ（schema.md更新）、MyBatis Mapper XML/Interface、履歴用モデルクラス、`JankenController` から履歴DAOを呼ぶ、テンプレ追加。テスト修正。
- 工数: 中〜大（1日〜数日）

推奨案
- 当面は B) アプリケーションメモリの `JankenHistoryService` を推奨。
  - 理由: 現状プロジェクトは簡易な学習用アプリであり、既に MyBatis 依存があるが履歴永続化はすぐに必要でないと判断。実装が容易で副作用が少ない。
  - 将来的に永続化が必要になれば、サービス層を切り替えることで C) に移行しやすい設計にする（インタフェースを定義して差し替え可能にする）。

推奨実装の詳細（B案）

1) 新規クラス: JankenHistoryService
- パス: `janken/src/main/java/oit/is/z9999/kaizi/janken/service/JankenHistoryService.java`
- 機能:
  - void add(String username, JankenResult result)
  - List<JankenResult> getLast(String username, int n)
- 実装案: ConcurrentHashMap<String, Deque<JankenResult>> を内部保持。Dequeは ArrayDeque や LinkedList。追加時にサイズを5に保つ。

2) コントローラ変更: JankenController
- 対応ファイル: `janken/src/main/java/oit/is/z9999/kaizi/janken/JankenController.java`
- 変更点:
  - `JankenHistoryService` を @Autowired で注入
  - POST `/janken/result` 処理で、Authentication / Principal から現在ユーザ名を取得し、履歴サービスに追加
  - 新規 GET `/janken/history` ハンドラを追加してテンプレートに履歴リストを渡す

3) テンプレート追加/変更
- `janken/src/main/resources/templates/history.html` を新規作成（直近5件を表示）
- `janken/src/main/resources/templates/janken.html` に履歴ページへ遷移するリンクを追加（例: <a href="/janken/history">対戦履歴</a>）

4) テスト追加/修正
- `JankenControllerTests` に履歴ページ表示のテストを追加（認証ユーザで GET `/janken/history` を行い model に history があることを確認）
- `JankenServiceTests` は基本変更不要だが、JankenHistoryService のユニットテストを追加することを推奨

テンプレート（例）
- `history.html` の簡易構造案:
  - 表形式で日時、あなたの手、CPUの手、勝敗を上から（直近）順に表示
  - 履歴がない場合は「履歴はありません」と表示

Principal / ユーザ名取得
- Spring Security を利用しているので、コントローラのメソッド引数に java.security.Principal または org.springframework.security.core.Authentication を受け取り、`principal.getName()` でログインユーザ名を取得する。

必要なファイル一覧（推奨B案を実装する場合）
- 変更/追加:
  - janken/src/main/java/oit/is/z9999/kaizi/janken/service/JankenHistoryService.java (新規)
  - janken/src/main/java/oit/is/z9999/kaizi/janken/JankenController.java (履歴追加処理、history GETハンドラ)
  - janken/src/main/resources/templates/history.html (新規)
  - janken/src/main/resources/templates/janken.html (履歴ページへのリンク追加)
  - janken/src/test/java/oit/is/z9999/kaizi/janken/JankenControllerTests.java (履歴表示テスト追加)

移行プラン（将来的に永続化する場合）
- JankenHistoryService にインタフェースを定義（例: HistoryService）して実装を分離
- DB用の実装（MyBatis + Mapper）を追加してプロファイルやSpringのBean定義で切り替え可能にする

DoD（Definition of Done）
- ./gradlew test が全テストで成功すること
- アプリ起動後（./gradlew bootRun）認証ユーザでログイン（例: yamada / tarou）して以下を確認:
  1. `/janken` ページに「対戦履歴」へのリンクが存在する
  2. 5回以上対戦した後、`/janken/history` を開くと直近5件が新しい順に表示される
  3. 履歴項目は「日時・あなたの手・CPUの手・勝敗」を含む

参考実装スニペット（参考用、レポート内）
- JankenHistoryService の擬似コード
```
@Component
public class JankenHistoryService {
  private final ConcurrentHashMap<String, Deque<JankenResult>> store = new ConcurrentHashMap<>();
  private static final int MAX = 5;

  public void add(String username, JankenResult r) {
    Deque<JankenResult> dq = store.computeIfAbsent(username, k -> new ArrayDeque<>());
    dq.addFirst(r);
    while (dq.size() > MAX) dq.removeLast();
  }

  public List<JankenResult> getLast(String username, int n) {
    return store.getOrDefault(username, new ArrayDeque<>()).stream().limit(n).collect(Collectors.toList());
  }
}
```

- Controllerでのユーザ名取得と追加例
```
@PostMapping("/janken/result")
public String playJanken(@RequestParam("userHand") String userHand, Model model, Principal principal) {
  JankenResult result = jankenService.play(userHand);
  model.addAttribute("result", result);
  historyService.add(principal.getName(), result);
  return "result";
}
```

参照・参考情報
- Spring Security: Principal/Authentication からユーザ名取得（Spring 公式ドキュメント）
- H2 / MyBatis を使った永続化は既存プロジェクトに依存しているため、必要に応じて schema.md にテーブル定義を追加すること

次の推奨アクション（実装フェーズに移る場合）
1. 本報告に基づき実装を行うか決定してください（セッション / メモリ / 永続化のいずれか）
2. 実装を行う場合は「実装」指示を出してください。実装開始前に docs/tasks.md にタスクを分割して記載します（計画フェーズの指示に従います）。

---
作成日: 2025-10-28
作成者: 自動調査レポート
