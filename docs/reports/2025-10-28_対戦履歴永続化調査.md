# 2025-10-28: 対戦履歴の永続化に関する調査報告

概要
- 要求: 対戦履歴を永続化し、各ユーザごとに直近5戦分を表示する機能を実装する。対戦ページから履歴ページへ遷移可能にする。
- 本レポートは、永続化方式の候補、推奨実装、必要な変更箇所、マイグレーション案、テスト・検証手順をまとめる。

要件（確定）
1. 各ユーザごとに直近5戦分をDBに保存すること
2. `/janken` から `/janken/history` へ遷移できること
3. 履歴は新しい順（played_at DESC）で最大5件を表示すること
4. 認証ユーザのみ自分の履歴を閲覧できること（他ユーザの履歴は不可）

推奨アプローチ
- 永続化方式: 組み込みH2（開発用）を用い、将来的なRDB移行を見据えてシンプルなテーブルで保存する。
- マッピング: MyBatis（既存プロジェクトにMyBatisが利用されているため統一）でMapperを実装する。
- マイグレーション: 開発は `schema.sql` または Flyway による管理を推奨（まずは schema.sql で簡易実装、将来 Flyway へ移行可能）。

DB スキーマ（例）
```sql
-- src/main/resources/schema.sql
CREATE TABLE IF NOT EXISTS janken_history (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(100) NOT NULL,
  user_hand VARCHAR(16) NOT NULL,
  cpu_hand VARCHAR(16) NOT NULL,
  result VARCHAR(16) NOT NULL,
  played_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_janken_history_username_played_at ON janken_history(username, played_at DESC);
```

MyBatis Mapper（概要）
- Interface: `JankenHistoryMapper`
- XML: `JankenHistoryMapper.xml`

Mapper インタフェース（例）
- insert: void insert(JankenHistory history)
- select recent: List<JankenHistory> selectRecentByUsername(@Param("username") String username, @Param("limit") int limit)
- delete older: optional（保守用）

例: select SQL
```xml
<select id="selectRecentByUsername" resultType="oit.is.z9999.kaizi.janken.model.JankenHistory">
  SELECT id, username, user_hand, cpu_hand, result, played_at
  FROM janken_history
  WHERE username = #{username}
  ORDER BY played_at DESC
  LIMIT #{limit}
</select>
```

モデルクラス
- `JankenHistory`（フィールド: id, username, userHand, cpuHand, result, playedAt）
  - 日時は java.time.LocalDateTime を使用

サービス層設計
- インタフェース: `HistoryService`
  - void add(String username, JankenResult result)
  - List<JankenHistory> getLast(String username, int n)
- 実装: `MybatisHistoryService`（Mapper を注入してDB操作を行う）
- 理由: インタフェース化により後でIn-memoryや別実装へ差し替え可能

コントローラ変更
- `JankenController` のPOST `/janken/result` 処理内で、認証ユーザ名を取得し HistoryService.add(...) を呼ぶ
  - Principal または Authentication を引数に受け取る
- 追加 GET `/janken/history` ハンドラを追加
  - Principal からユーザ名を取得
  - HistoryService.getLast(username, 5) を呼びテンプレートへ渡す
  - URL: `/janken/history`（認証制限は既存の SecurityConfig を活用）

テンプレート
- `templates/history.html` を新規作成
  - テーブルで「日時」「あなたの手」「CPUの手」「勝敗」を直近順で表示
  - 履歴がない場合は「履歴はありません」と表示
- `templates/janken.html` に履歴ページへのリンクを追加（例: <a href="/janken/history">対戦履歴</a>）

マイグレーションと設定
- 開発段階: `src/main/resources/schema.sql` を置くと Spring Boot は自動で実行できる（spring.datasource.initialization-mode など確認）
- 本番移行時: Flyway または Liquibase の導入を推奨
- `application.properties` 例（H2メモリ）:
  - spring.datasource.url=jdbc:h2:mem:jankendb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=false
  - spring.datasource.username=sa
  - spring.datasource.password=
  - spring.datasource.driver-class-name=org.h2.Driver
  - spring.h2.console.enabled=true (開発時のみ)
  - mybatis.configuration.map-underscore-to-camel-case=true

テスト計画
- 単体テスト:
  - `JankenHistoryMapper` の Mapper テスト（@MybatisTest + H2）で insert と select の動作確認
  - `MybatisHistoryService` のユニットテスト（Mapper をモックする）
- 統合テスト:
  - `JankenControllerTests` に対して SpringBootTest で認証ユーザで GET `/janken/history` を実行し model に history が存在することを確認
  - end-to-end: アプリ起動後に POST `/janken/result` を複数回実行し `/janken/history` で直近5件が返ることを確認

セキュリティ考慮
- SQL には必ず username を WHERE に含める（認証済みユーザのもののみ取得）
- Controller 側でも Principal を使ってユーザ名を取得し、テンプレートへ渡す際に他ユーザのデータを渡さない

パフォーマンス・保守
- 小規模アプリでは問題なし。大量データを扱う場合はパーティショニングや archive 方針を検討
- 古い履歴の削除はバッチで実施するか、表示のみであれば LIMIT で対応

必要なファイル一覧（実装時に追加/変更）
- 追加:
  - src/main/resources/schema.sql
  - src/main/java/oit/is/z9999/kaizi/janken/model/JankenHistory.java
  - src/main/java/oit/is/z9999/kaizi/janken/mapper/JankenHistoryMapper.java
  - src/main/resources/mapper/JankenHistoryMapper.xml
  - src/main/java/oit/is/z9999/kaizi/janken/service/HistoryService.java
  - src/main/java/oit/is/z9999/kaizi/janken/service/MybatisHistoryService.java
  - src/main/resources/templates/history.html
- 変更:
  - src/main/java/oit/is/z9999/kaizi/janken/JankenController.java（履歴追加呼び出し、GET /janken/history ハンドラ）
  - src/main/resources/templates/janken.html（履歴へのリンク）
  - build.gradle に MyBatis 依存が無ければ追加（implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:2.2.2' など）

工数見積り
- schema + Mapper + model + service + Controller + template + 基本テスト: 1日〜2日
- Flyway導入や追加の堅牢なテストを含める場合: 2日〜3日

DoD（Definition of Done）
1. `./gradlew test` がすべて成功すること
2. `./gradlew bootRun` でアプリ起動後、認証ユーザでログインして `/janken` に履歴へのリンクがあること
3. 5回以上対戦した後に `/janken/history` を開くと直近5件が日時降順で表示されること
4. テストで Controller からの履歴取得が確認できること

参考
- Spring Boot（公式）: https://spring.io/projects/spring-boot
- MyBatis Spring Boot Starter: https://mybatis.org/spring-boot-starter/
- H2 Database: https://www.h2database.com/

次の推奨アクション
1. 実装を開始する場合は「実装」と指示してください。実装前に `docs/tasks.md` にタスクを分割して提示します（計画フェーズに従う）。
2. まずは schema.sql を追加して MyBatis Mapper とサービス層の雛形を実装するのを推奨します。

---
作成日: 2025-10-28
作成者: 自動調査レポート（永続化版）
